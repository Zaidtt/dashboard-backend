<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Análisis de Dataset</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.8.1/core.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
        }
        .chart { border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>
    <h1>Dashboard de Visualización de Dataset</h1>
    <input type="file" id="upload-file">
    <button id="upload-btn">Subir Nuevo Dataset</button>
    <div class="dashboard" id="charts"></div>

    <py-config>
        packages = ["pandas", "micropip"]
    </py-config>

<py-script>
import asyncio
import js
import pandas as pd
import micropip
from pyodide.http import pyfetch
import plotly.express as px
import plotly.io as pio

# Función async para instalar dependencias
async def install_dependencies():
    try:
        await micropip.install('plotly==5.22.0')
    except Exception as e:
        print("No se pudo instalar Plotly, se ignora:", e)

async def initialize_app():
    await install_dependencies()
    await render_charts()

API_URL = "/data/"
UPLOAD_URL = "/upload/"

async def fetch_data():
    response = await pyfetch(API_URL)
    if response.status == 200:
        return await response.json()
    return None

async def upload_file(event):
    file_input = js.document.getElementById("upload-file")
    if file_input.files.length > 0:
        file = file_input.files[0]
        form_data = js.FormData.new()
        form_data.append("file", file)
        response = await pyfetch(UPLOAD_URL, method="POST", body=form_data)
        if response.status == 200:
            await render_charts()
            js.alert("Dataset actualizado!")

async def render_charts():
    try:
        data = await fetch_data()
        if data:
            charts_div = js.document.getElementById("charts")
            charts_div.innerHTML = ""
            df = pd.DataFrame(data['data'])
            
            # Valores nulos por columna
            nulls = pd.Series(data['nulls'])
            fig_nulls = px.bar(x=nulls.index, y=nulls.values, title="Valores Nulos por Columna")
            div_nulls = js.document.createElement("div")
            div_nulls.className = "chart"
            div_nulls.innerHTML = pio.to_html(fig_nulls, full_html=False)
            charts_div.appendChild(div_nulls)
            
            # Proporción de duplicados
            dup_fig = px.pie(
                names=['Únicos', 'Duplicados'], 
                values=[len(df) - data['duplicates'], data['duplicates']], 
                title="Proporción de Duplicados"
            )
            div_dup = js.document.createElement("div")
            div_dup.className = "chart"
            div_dup.innerHTML = pio.to_html(dup_fig, full_html=False)
            charts_div.appendChild(div_dup)
            
            # Boxplot por columna numérica
            num_cols = df.select_dtypes(include='number').columns
            for col in num_cols:
                fig_box = px.box(df, y=col, title=f"Boxplot de {col}")
                div_box = js.document.createElement("div")
                div_box.className = "chart"
                div_box.innerHTML = pio.to_html(fig_box, full_html=False)
                charts_div.appendChild(div_box)
            
            # Histograma de la primera columna numérica
            if len(num_cols) > 0:
                fig_hist = px.histogram(df, x=num_cols[0], title=f"Histograma de {num_cols[0]}")
                div_hist = js.document.createElement("div")
                div_hist.className = "chart"
                div_hist.innerHTML = pio.to_html(fig_hist, full_html=False)
                charts_div.appendChild(div_hist)
    except Exception as e:
        js.alert(f"Error: {str(e)}")

js.document.getElementById("upload-btn").onclick = lambda e: asyncio.ensure_future(upload_file(e))

asyncio.ensure_future(initialize_app())
</py-script>
</body>
</html>
